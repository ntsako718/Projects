{% extends "Topwinz/layout.html" %}

{% block title %} Topwinz {% endblock %}

{% block content %}
<div class="home_container">
    <h1>Latest Raffle Baskets</h1>

    <div class="tabs">
        {% for raffle in raffles %}
            <button class="tab-btn" onclick="showTab('{{ raffle.id }}')">
                {{ raffle.name }}
            </button>
        {% endfor %}
    </div>

    <div class="tab-content">
        {% for raffle in raffles %}
        <div id="tab-{{ raffle.id }}" class="tab">
            <div class="raffle-gallery">
                <img src="{{ raffle.image.url }}" alt="{{ raffle.name }}" class="raffle-image">
            </div>
            <h2>{{ raffle.name }}</h2>
            <p><strong>Tickets Left:</strong> {{ raffle.tickets_left }}</p>
            <p><strong>Ticket Price:</strong> R{{ raffle.ticket_price }}</p>

            <div class="progress-bar">
                <div class="progress" style="width: {{ raffle.tickets_percentage }}%;"></div>
            </div>

            {% if raffle.tickets_left > 0 %}
                <form method="post" action="{% url 'Topwinz_app:buy_ticket' raffle.id %}">
                    {% csrf_token %}
                    <button type="submit" class="buy-btn">Buy Ticket</button>
                </form>
            {% else %}
                <p class="sold-out">Raffle Closed!</p>

                {% if raffle.started %}
                    <div class="winner-reveal">
                        <h2>And the winner is...</h2>
                        <p id="winner-name">{{ raffle.winner.username }}</p>
                        <button id="celebrate" class="celebrate-btn">Celebrate!</button>
                    </div>
                {% else %}
                    <div id="countdown-{{ raffle.id }}">
                        <h3>Raffle Starting In:</h3>
                        <p id="timer-{{ raffle.id }}"></p>
                    </div>
                {% endif %}
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>

<script>
    // Function to show the countdown
    function startCountdown(raffleId, countdownTime) {
        var countdownElement = document.getElementById('timer-' + raffleId);
        var countdownInterval = setInterval(function() {
            var minutes = Math.floor(countdownTime / 60);
            var seconds = countdownTime % 60;
            countdownElement.innerHTML = minutes + "m " + seconds + "s";

            countdownTime--;
            if (countdownTime <= 0) {
                clearInterval(countdownInterval);
                document.getElementById('timer-' + raffleId).innerHTML = "Raffle Started!";
                // Trigger Winner Reveal after the countdown ends
                revealWinner(raffleId);
            }
        }, 1000);
    }

    // Function to reveal the winner after countdown
    function revealWinner(raffleId) {
        setTimeout(function() {
            var winnerElement = document.getElementById('winner-name');
            if (winnerElement) {
                winnerElement.innerHTML = "Congratulations to the winner!";
                document.getElementById('celebrate').style.display = "block";
            }
        }, 2000); // Delay the winner announcement for excitement
    }

    // Example to start countdown for a specific raffle
    {% for raffle in raffles %}
        {% if raffle.tickets_left == 0 and not raffle.started %}
            startCountdown({{ raffle.id }}, 300);  // 5 minutes countdown
        {% endif %}
    {% endfor %}
</script>

<script>
    function showTab(raffleId) {
        // Hide all tabs
        const allTabs = document.querySelectorAll('.tab');
        allTabs.forEach(tab => tab.style.display = 'none');

        // Show the clicked tab
        const activeTab = document.getElementById('tab-' + raffleId);
        if (activeTab) {
            activeTab.style.display = 'block';
        }
    }

    // Show the first tab by default
    document.addEventListener('DOMContentLoaded', () => {
        showTab('{{ raffles.first.id }}');
    });
</script>

{% endblock %}
